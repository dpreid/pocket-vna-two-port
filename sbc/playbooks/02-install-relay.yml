---
- name: install relay
  hosts: pvna2:pvna2pilot
  become: yes
  gather_facts: yes
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
  tasks:

  # so we can use this playbook for update, stop the existing service
  # and ignore errors - typically only thrown if it does not exist
  - name: stop relay service
    service:
      name: relay
      state: stopped
    ignore_errors: true
     
  - name: stop relay-rules service
    service:
      name: relay-rules
      state: stopped
    ignore_errors: true    
     
  - name: build cmd/relay from practable/relay
    command: ./build.sh
    args:
      chdir: /home/pi/sources/relay/scripts/build
      
  - name: install cmd/relay to usr/local/bin
    command: cp relay /usr/local/bin
    args:
      chdir: /home/pi/sources/relay/cmd/relay
      
  - name: copy data access file
    copy: src=../autogenerated/data.access.{{ practable_label }} dest=/etc/practable/data.access

  - name: copy data token file
    copy: src=../autogenerated/data.token.{{ practable_label }} dest=/etc/practable/data.token
      
  - name: copy video access file
    copy: src=../autogenerated/video.access.{{ practable_label }} dest=/etc/practable/video.access

  - name: copy video token file
    copy: src=../autogenerated/video.token.{{ practable_label }} dest=/etc/practable/video.token
    
  - name: install relay-rules to usr/local/bin
    copy:
      src: ../files/relay-rules
      dest: /usr/local/bin/relay-rules
      owner: root
      group: root
      mode: a+x
      
  - name: Copy relay service file
    copy:
      src: ../services/relay.service
      dest: /etc/systemd/system/relay.service
      owner: root
      group: root
      
  - name: Copy relay-rules service file 
    copy:
      src: ../services/relay-rules.service
      dest: /etc/systemd/system/relay-rules.service
      owner: root
      group: root     

  - name: Just force systemd to reread configs (2.4 and above)
    ansible.builtin.systemd:
      daemon_reload: yes

  - name: start relay service
    service:
      name: relay
      state: started
      enabled: true
      
  - name: start relay-rules service
    service:
      name: relay-rules
      state: started
      enabled: true     

