#!/bin/bash
# example relaytoken https://relay-access.practable.io ~/secret/sessionrelay.pat
cd ../autogenerated
DIR=.
filename='./(\w*).\w*.(\w*)'

export ACCESSTOKEN_LIFETIME=157680000
export ACCESSTOKEN_READ=true
export ACCESSTOKEN_WRITE=true
export ACCESSTOKEN_SECRET=$(cat $2)
# the topic is updated in the main loop
export ACCESSTOKEN_TOPIC=123
export ACCESSTOKEN_AUDIENCE=$1

for i in $DIR/data.access.*; do
	[[ $i =~ $filename ]]
	first="${BASH_REMATCH[1]}"
	last="${BASH_REMATCH[2]}"
	out="${first}.token.${last}"
	export ACCESSTOKEN_TOPIC="$last-data"
	../bin/relay token > "$out"
done

export ACCESSTOKEN_READ=false

for i in $DIR/video.access.*; do
	[[ $i =~ $filename ]]
	first="${BASH_REMATCH[1]}"
	last="${BASH_REMATCH[2]}"
	out="${first}.token.${last}"
	export ACCESSTOKEN_TOPIC="$last-video"
	../bin/relay token > "$out"
done
